<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ajukan Permohonan - Kecamatan Plemahan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

    <!-- Navbar -->
    <nav class="bg-white/95 backdrop-blur-sm shadow-sm fixed w-full z-50 top-0 border-b border-gray-100 transition-all duration-300">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <a href="index.html" class="text-2xl font-bold text-blue-700 tracking-tight">Pelayanan <span class="text-gray-600">Kec. Plemahan</span></a>
                </div>
                <div class="hidden md:flex space-x-8">
                    <a href="index.html" class="text-gray-600 hover:text-blue-700 font-medium transition">Beranda</a>
                    <a href="index.html#services" class="text-gray-600 hover:text-blue-700 font-medium transition">Layanan</a>
                    <a href="permohonan.html" class="text-blue-700 font-bold transition">Hubungi Kami</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Contact Section -->
    <section id="contact" class="pt-32 pb-24 bg-white min-h-screen">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-12">
                <h1 class="text-4xl font-bold text-gray-900 mb-4">Hubungi & Ajukan Layanan</h1>
                <p class="text-lg text-gray-600 max-w-2xl mx-auto">Kami siap melayani kebutuhan administrasi Anda. Silakan isi formulir di bawah ini atau kunjungi kantor kami untuk bantuan langsung.</p>
            </div>

            <div class="flex flex-col lg:flex-row gap-8 bg-white rounded-3xl shadow-xl overflow-hidden border border-gray-100">
                <!-- Sidebar Contact Info (Left) -->
                <div class="lg:w-1/3 bg-blue-700 text-white p-10 flex flex-col justify-between relative overflow-hidden">
                    <div class="absolute top-0 right-0 -mr-10 -mt-10 w-40 h-40 bg-blue-600 rounded-full opacity-50"></div>
                    <div class="absolute bottom-0 left-0 -ml-10 -mb-10 w-40 h-40 bg-blue-800 rounded-full opacity-50"></div>
                    
                    <div class="relative z-10">
                        <h3 class="text-2xl font-bold mb-8">Informasi Kantor</h3>
                        <div class="space-y-8">
                            <div class="flex items-start space-x-4">
                                <div class="mt-1 bg-blue-600/50 p-3 rounded-xl">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-blue-100 text-lg">Alamat</h4>
                                    <p class="text-blue-50 leading-relaxed">Jl. Raya Plemahan No. 123, Kec. Plemahan, Kab. Kediri, Jawa Timur</p>
                                </div>
                            </div>
                            <div class="flex items-start space-x-4">
                                <div class="mt-1 bg-blue-600/50 p-3 rounded-xl">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-blue-100 text-lg">Kontak</h4>
                                    <p class="text-blue-50">+62 812-3456-7890</p>
                                    <p class="text-blue-50">kecamatan@plemahan.go.id</p>
                                </div>
                            </div>
                            <div class="flex items-start space-x-4">
                                <div class="mt-1 bg-blue-600/50 p-3 rounded-xl">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-blue-100 text-lg">Jam Operasional</h4>
                                    <p class="text-blue-50">Senin - Jumat: 08.00 - 15.00 WIB</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Form Section (Right) -->
                <div class="lg:w-2/3 p-8 md:p-12">
                    <!-- Tabs Navigation -->
                    <div class="flex mb-8 border-b border-gray-200">
                        <button type="button" id="tab-input" class="w-1/2 py-4 text-center font-bold text-blue-600 border-b-2 border-blue-600 transition-colors duration-200 focus:outline-none">
                            1. Isi Data
                        </button>
                        <button type="button" id="tab-review" class="w-1/2 py-4 text-center font-medium text-gray-500 border-b-2 border-transparent hover:text-gray-700 transition-colors duration-200 focus:outline-none relative">
                            2. Review & Kirim
                            <span id="badge-count" class="absolute top-3 right-4 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full hidden">0</span>
                        </button>
                    </div>

                    <form id="serviceForm" class="overflow-hidden transition-[height] duration-500 ease-in-out">
                        <div id="form-slider" class="flex transition-transform duration-500 ease-in-out items-start">
                        <!-- BAGIAN 1: INPUT DATA -->
                        <div id="input-section" class="w-full flex-shrink-0 space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="md:col-span-2">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Jenis Pelayanan</label>
                                <select id="input-layanan" class="w-full px-4 py-3 rounded-xl bg-gray-50 border border-gray-200 focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200">
                                    <option>Rekomendasi SKCK</option>
                                    <option>Laporan Kejadian</option>
                                    <option>Legalisasi Dokumen</option>
                                    <option>Rekomendasi SKTM</option>
                                    <option>Rekomendasi Subsidi Listrik</option>
                                    <option>Rekomendasi Izin Keramaian</option>
                                    <option>Rekomendasi Dispensasi Nikah</option>
                                    <option>Rekomendasi Pengajuan Proposal</option>
                                    <option>Rekom Pindah Tempat Antar Kab/Kota</option>
                                    <option>Sahaja Lekat</option>
                                    <option>Surat Keterangan Waris</option>
                                    <option>Rekomendasi Surat Keterangan Lainnya</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Nama Lengkap</label>
                                <input type="text" id="input-nama" required class="w-full px-4 py-3 rounded-xl bg-gray-50 border border-gray-200 focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200" placeholder="Nama Sesuai KTP">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Desa</label>
                                <input type="text" id="input-desa" required class="w-full px-4 py-3 rounded-xl bg-gray-50 border border-gray-200 focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200" placeholder="Nama Desa Domisili">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Umur</label>
                                <input type="number" id="input-umur" required class="w-full px-4 py-3 rounded-xl bg-gray-50 border border-gray-200 focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200" placeholder="Contoh: 25">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Jenis Kelamin</label>
                                <select id="input-jk" class="w-full px-4 py-3 rounded-xl bg-gray-50 border border-gray-200 focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200">
                                    <option>Laki-laki</option>
                                    <option>Perempuan</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">No Telepon (WhatsApp)</label>
                                <input type="tel" id="input-telepon" required class="w-full px-4 py-3 rounded-xl bg-gray-50 border border-gray-200 focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition duration-200" placeholder="08xxxxxxxxxx">
                            </div>
                        </div>

                            <button type="button" id="btn-tambah-data" class="w-full bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-blue-800 hover:shadow-xl transition duration-300 transform hover:-translate-y-0.5">
                                + Tambahkan ke Tabel Antrian
                            </button>
                        </div>

                        <!-- BAGIAN 2: REVIEW DATA (REAL TIME) -->
                        <div id="review-section" class="w-full flex-shrink-0 space-y-6">
                            <div id="preview-container">
                                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                                    <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                        <span class="bg-blue-100 text-blue-700 p-1.5 rounded-lg"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg></span>
                                        Daftar Antrian
                                    </h3>
                                    <div class="flex gap-3">
                                        <button type="button" id="btn-download-csv" class="inline-flex items-center px-3 py-2 bg-green-50 text-green-700 hover:bg-green-100 rounded-lg text-sm font-medium transition-colors border border-green-200 shadow-sm">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                                            Download Excel
                                        </button>
                                        <button type="button" id="btn-reset-tabel" class="inline-flex items-center px-3 py-2 bg-red-50 text-red-700 hover:bg-red-100 rounded-lg text-sm font-medium transition-colors border border-red-200 shadow-sm">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                            Reset
                                        </button>
                                    </div>
                                </div>
                                <div class="overflow-x-auto max-h-[500px] overflow-y-auto relative bg-white shadow-lg rounded-xl border border-gray-200 ring-1 ring-black ring-opacity-5">
                                    <table class="min-w-full divide-y divide-gray-100">
                                        <thead id="preview-table-head" class="bg-gray-50 sticky top-0 z-10 shadow-sm"></thead>
                                        <tbody id="preview-table-body" class="divide-y divide-gray-100 bg-white"></tbody>
                                    </table>
                                </div>
                            </div>

                            <div class="flex gap-4">
                                <button type="button" id="btn-tambah-lagi" class="w-1/2 bg-gray-100 text-gray-700 font-bold py-4 rounded-xl shadow hover:bg-gray-200 transition duration-300">
                                    + Tambah Data Lain
                                </button>
                                <button type="button" id="btn-kirim" class="w-full bg-green-600 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-green-700 hover:shadow-xl transition duration-300 transform hover:-translate-y-0.5 flex justify-center items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-8.683-2.031-9.667-.272-.099-.47-.149-.669-.149-.198 0-.42.001-.643.001-.223 0-.586.085-.892.41-.307.325-1.178 1.151-1.178 2.807 0 1.656 1.203 3.256 1.371 3.481.168.225 2.368 3.616 5.737 5.07 2.399 1.035 2.887.829 3.407.779.52-.05 1.758-.718 2.006-1.411.248-.693.248-1.288.173-1.412z"/></svg>
                                    Kirim Permohonan via WhatsApp
                                </button>
                            </div>
                        </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-slate-900 text-white py-12 border-t border-slate-800 relative overflow-hidden">
        <div class="absolute top-0 left-1/2 -translate-x-1/2 w-full h-1 bg-gradient-to-r from-transparent via-blue-500 to-transparent opacity-50"></div>
        <div class="max-w-7xl mx-auto px-4 text-center relative z-10">
            <h3 class="text-3xl font-bold mb-2 tracking-tight">Kecamatan Plemahan</h3>
            <p class="text-blue-200 font-medium mb-6">Melayani dengan Sepenuh Hati, Cepat, dan Transparan.</p>
            
            <div class="inline-block px-6 py-2 rounded-full bg-blue-900/50 border border-blue-700/50 backdrop-blur-sm mb-8">
                <span class="text-slate-300 text-sm uppercase tracking-widest mr-2">Motto</span>
                <span class="text-white font-bold tracking-wider">IKHLAS</span>
            </div>
            
            <div class="w-24 h-1 bg-gradient-to-r from-blue-600 to-indigo-600 mx-auto rounded-full mb-8"></div>
            <p class="text-slate-500 text-sm">&copy; 2024 Kecamatan Plemahan. All rights reserved.</p>
        </div>
    </footer>

    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- KONFIGURASI JSONBIN.IO ---
            const API_KEY = '$2a$10$h9UZB5ypIv9XPDOSdgWmeOAZ6QVatUxWmW/nXKiRB5Cq6CieMjRPa';
            const BIN_ID = '6965bfb8d0ea881f406809a4';
            const API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

            const serviceForm = document.getElementById('serviceForm');
            const btnTambahData = document.getElementById('btn-tambah-data');
            const btnTambahLagi = document.getElementById('btn-tambah-lagi');
            const btnKirim = document.getElementById('btn-kirim');
            const btnResetTabel = document.getElementById('btn-reset-tabel');
            const btnDownloadCsv = document.getElementById('btn-download-csv');
            const inputSection = document.getElementById('input-section');
            const reviewSection = document.getElementById('review-section');
            const formSlider = document.getElementById('form-slider');
            const tabInput = document.getElementById('tab-input');
            const tabReview = document.getElementById('tab-review');
            const badgeCount = document.getElementById('badge-count');
            const tableHead = document.getElementById('preview-table-head');
            const tableBody = document.getElementById('preview-table-body');

            // --- LOGIKA AUTO-SELECT LAYANAN DARI URL ---
            const urlParams = new URLSearchParams(window.location.search);
            const layananParam = urlParams.get('layanan');
            if (layananParam) {
                const inputLayanan = document.getElementById('input-layanan');
                if (inputLayanan) {
                    for (let i = 0; i < inputLayanan.options.length; i++) {
                        if (inputLayanan.options[i].value === layananParam || inputLayanan.options[i].text === layananParam) {
                            inputLayanan.selectedIndex = i;
                            break;
                        }
                    }
                }
            }

            let currentTab = 'input';

            function updateFormHeight() {
                const activeSection = currentTab === 'input' ? inputSection : reviewSection;
                // Sedikit delay untuk memastikan render layout selesai
                setTimeout(() => {
                    serviceForm.style.height = activeSection.offsetHeight + 'px';
                }, 50);
            }

            // Fungsi Ganti Tab
            function switchTab(tab) {
                currentTab = tab;
                if (tab === 'input') {
                    formSlider.style.transform = 'translateX(0)';
                    tabInput.className = "w-1/2 py-4 text-center font-bold text-blue-600 border-b-2 border-blue-600 transition-colors duration-200 focus:outline-none";
                    tabReview.className = "w-1/2 py-4 text-center font-medium text-gray-500 border-b-2 border-transparent hover:text-gray-700 transition-colors duration-200 focus:outline-none relative";
                } else {
                    formSlider.style.transform = 'translateX(-100%)';
                    tabInput.className = "w-1/2 py-4 text-center font-medium text-gray-500 border-b-2 border-transparent hover:text-gray-700 transition-colors duration-200 focus:outline-none";
                    tabReview.className = "w-1/2 py-4 text-center font-bold text-blue-600 border-b-2 border-blue-600 transition-colors duration-200 focus:outline-none relative";
                }
                updateFormHeight();
            }

            tabInput.addEventListener('click', () => switchTab('input'));
            tabReview.addEventListener('click', () => switchTab('review'));
            if (btnTambahLagi) btnTambahLagi.addEventListener('click', () => switchTab('input'));
            
            // Set tinggi awal & event listener resize
            updateFormHeight();
            window.addEventListener('resize', updateFormHeight);

            function updateBadge() {
                const count = tableBody.querySelectorAll('tr.data-row').length;
                if (count > 0) {
                    badgeCount.textContent = count;
                    badgeCount.classList.remove('hidden');
                } else {
                    badgeCount.classList.add('hidden');
                }
            }

            // --- FUNGSI PENYIMPANAN DATA (LOCAL STORAGE) ---
            function saveDataToLocal() {
                const rows = [];
                document.querySelectorAll('#preview-table-body tr.data-row').forEach(row => {
                    const cells = row.querySelectorAll('td');
                    // Ambil data dari kolom (index 1 s/d 7)
                    rows.push({
                        layanan: cells[1].innerText,
                        nama: cells[2].innerText,
                        desa: cells[3].innerText,
                        umur: cells[4].innerText,
                        jk: cells[5].innerText,
                        telepon: cells[6].innerText
                    });
                });
                localStorage.setItem('antrian_layanan', JSON.stringify(rows));
            }
            
            // --- FUNGSI CLOUD (JSONBIN.IO) ---
            async function saveDataToCloud() {
                const rows = [];
                document.querySelectorAll('#preview-table-body tr.data-row').forEach(row => {
                    const cells = row.querySelectorAll('td');
                    // Ambil data dari kolom (index 1 s/d 7)
                    rows.push({
                        layanan: cells[1].innerText,
                        nama: cells[2].innerText,
                        desa: cells[3].innerText,
                        umur: cells[4].innerText,
                        jk: cells[5].innerText,
                        telepon: cells[6].innerText
                    });
                });

                try {
                    await fetch(API_URL, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': API_KEY
                        },
                        body: JSON.stringify(rows)
                    });
                    console.log("Data berhasil disimpan ke JSONBin");
                } catch (error) {
                    console.error("Gagal menyimpan data:", error);
                }
            }

            async function loadDataFromCloud() {
                try {
                    const response = await fetch(API_URL, {
                        method: 'GET',
                        headers: {
                            'X-Master-Key': API_KEY
                        }
                    });
                    const result = await response.json();
                    
                    // JSONBin v3 menyimpan data di dalam properti .record
                    const data = result.record; 
                    
                    if (Array.isArray(data)) {
                        tableBody.innerHTML = ''; // Reset tabel
                        data.forEach(d => addRowToTable(d.layanan, d.nama, d.desa, d.umur, d.jk, d.telepon));
                        updateBadge();
                        updateFormHeight();
                    }
                } catch (error) {
                    console.error("Gagal memuat data:", error);
                }
            }

            // --- FUNGSI RENDER TABEL ---
            function addRowToTable(layanan, nama, desa, umur, jk, telepon) {
                const rowNumber = tableBody.querySelectorAll('tr.data-row').length + 1;
                let newRowHTML = '<tr class="bg-white hover:bg-gray-50 transition-colors duration-200 data-row group">';
                newRowHTML += `<td class="whitespace-nowrap py-4 pl-6 pr-3 text-sm text-gray-500 text-center font-bold row-number">${rowNumber}</td>`;
                newRowHTML += `<td class="whitespace-nowrap px-6 py-4 text-sm text-gray-900 font-medium">${layanan}</td>`;
                newRowHTML += `<td class="whitespace-nowrap px-6 py-4 text-sm text-gray-900 font-medium">${nama}</td>`;
                newRowHTML += `<td class="whitespace-nowrap px-6 py-4 text-sm text-gray-900 font-medium">${desa}</td>`;
                newRowHTML += `<td class="whitespace-nowrap px-6 py-4 text-sm text-gray-900 font-medium">${umur}</td>`;
                newRowHTML += `<td class="whitespace-nowrap px-6 py-4 text-sm text-gray-900 font-medium">${jk}</td>`;
                newRowHTML += `<td class="whitespace-nowrap px-6 py-4 text-sm text-gray-900 font-medium">${telepon}</td>`;
                newRowHTML += `<td class="whitespace-nowrap px-6 py-4 text-sm text-gray-500 text-center"><button type="button" class="text-red-400 hover:text-red-600 p-2 rounded-full hover:bg-red-50 transition btn-delete" title="Hapus"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></td>`;
                newRowHTML += '</tr>';
                tableBody.insertAdjacentHTML('beforeend', newRowHTML);
            }

            function loadDataFromLocal() {
                const saved = localStorage.getItem('antrian_layanan');
                if (saved) {
                    try {
                        const rows = JSON.parse(saved);
                        rows.forEach(d => addRowToTable(d.layanan, d.nama, d.desa, d.umur, d.jk, d.telepon));
                        updateBadge();
                    } catch(e) { console.error("Gagal memuat data", e); }
                }
            }

            // 1. Inisialisasi Header Tabel Langsung
            // Tambahkan kolom No dan Aksi
            const headers = ['No', 'Jenis Layanan', 'Nama Lengkap', 'Desa', 'Umur', 'Jenis Kelamin', 'No. Telepon', 'Aksi'];
            let headerHTML = '<tr class="border-b border-gray-200">';
            headers.forEach((h, index) => {
                let widthClass = (index === 0 || index === headers.length - 1) ? 'w-16 text-center' : 'text-left';
                
                headerHTML += `<th scope="col" class="px-6 py-4 text-xs font-bold text-gray-600 uppercase tracking-wider ${widthClass} bg-gray-50">
                    ${h}
                </th>`;
            });
            headerHTML += '</tr>';
            tableHead.innerHTML = headerHTML;

            // --- FITUR VALIDASI REAL-TIME ---
            function showError(input, message) {
                let errorEl = input.parentNode.querySelector('.validation-error');
                if (!errorEl) {
                    errorEl = document.createElement('p');
                    errorEl.className = 'text-red-500 text-xs mt-1 font-medium validation-error transition-all duration-200';
                    input.parentNode.appendChild(errorEl);
                }
                errorEl.textContent = message;
                input.classList.add('border-red-500', 'focus:ring-red-500', 'focus:border-red-500');
                input.classList.remove('border-gray-200', 'focus:ring-blue-500', 'focus:border-blue-500');
            }

            function clearError(input) {
                const errorEl = input.parentNode.querySelector('.validation-error');
                if (errorEl) {
                    errorEl.remove();
                }
                input.classList.remove('border-red-500', 'focus:ring-red-500', 'focus:border-red-500');
                input.classList.add('border-gray-200', 'focus:ring-blue-500', 'focus:border-blue-500');
            }

            const inputTelepon = document.getElementById('input-telepon');
            if (inputTelepon) {
                inputTelepon.addEventListener('input', function() {
                    if (/\D/.test(this.value)) showError(this, 'Nomor telepon hanya boleh berisi angka.');
                    else clearError(this);
                });
            }

            if (btnTambahData) {
                btnTambahData.addEventListener('click', function() {
                    // Ambil nilai dari form
                    const inputLayanan = document.getElementById('input-layanan');
                    const inputNama = document.getElementById('input-nama');
                    const inputDesa = document.getElementById('input-desa');
                    const inputUmur = document.getElementById('input-umur');
                    const inputJk = document.getElementById('input-jk');
                    const inputTelepon = document.getElementById('input-telepon');

                    const layanan = inputLayanan.value;
                    const nama = inputNama.value.trim();
                    const desa = inputDesa.value.trim();
                    const umur = inputUmur.value.trim();
                    const jk = inputJk.value;
                    const telepon = inputTelepon.value.trim();

                    // Validasi input wajib
                    if (!nama || !desa || !umur || !telepon) {
                        alert('Mohon lengkapi semua data sebelum melanjutkan.');
                        return;
                    }
                    
                    // Cek jika masih ada error validasi visual
                    if (document.querySelector('.validation-error')) {
                        alert('Mohon perbaiki kesalahan pada form (teks berwarna merah) sebelum menambahkan data.');
                        return;
                    }

                    // Tambahkan ke tabel dan simpan
                    addRowToTable(layanan, nama, desa, umur, jk, telepon);
                    saveDataToLocal();
                    
                    // Simpan ke Cloud (Google Sheets)
                    saveDataToCloud();

                    // Reset Form agar siap untuk data berikutnya
                    inputNama.value = '';
                    inputDesa.value = '';
                    inputUmur.value = '';
                    inputTelepon.value = '';
                    inputLayanan.selectedIndex = 0;
                    inputJk.selectedIndex = 0;

                    // Update Badge & Pindah ke Tab Review
                    updateBadge();
                    switchTab('review');
                });

                // Event Listener untuk Tombol Hapus (Delegation)
                tableBody.addEventListener('click', function(e) {
                    const btnDelete = e.target.closest('.btn-delete');
                    if (btnDelete) {
                        btnDelete.closest('tr').remove();
                        // Update Nomor Urut
                        const rows = tableBody.querySelectorAll('tr.data-row');
                        rows.forEach((row, index) => {
                            row.querySelector('.row-number').textContent = index + 1;
                        });
                        saveDataToLocal(); // Simpan perubahan setelah hapus
                        
                        saveDataToCloud(); // Simpan perubahan ke cloud setelah hapus
                        updateBadge();
                        updateFormHeight();
                    }
                });
            }

            // Event Listener untuk Tombol Reset Tabel
            if (btnResetTabel) {
                btnResetTabel.addEventListener('click', function() {
                    if(confirm('Apakah Anda yakin ingin menghapus semua data di tabel?')) {
                        // Hapus semua baris data (bukan filler, bukan live row)
                        const rows = tableBody.querySelectorAll('tr.data-row');
                        rows.forEach(row => row.remove());
                        localStorage.removeItem('antrian_layanan'); // Hapus dari storage
                        
                        saveDataToCloud(); // Update cloud menjadi kosong
                        updateBadge();
                        updateFormHeight();
                    }
                });
            }

            // Event Listener untuk Tombol Download CSV
            if (btnDownloadCsv) {
                btnDownloadCsv.addEventListener('click', function() {
                    const rows = tableBody.querySelectorAll('tr.data-row');
                    if (rows.length === 0) {
                        alert('Tabel antrian kosong. Silakan isi formulir dan klik "Tambahkan ke Tabel Antrian" terlebih dahulu.');
                        return;
                    }

                    let csv = [];
                    // Header (Tanpa kolom Aksi)
                    const headers = ['No', 'Jenis Layanan', 'Nama Lengkap', 'Desa', 'Umur', 'Jenis Kelamin', 'No. Telepon'];
                    csv.push(headers.map(h => `"${h}"`).join(","));

                    // Data
                    rows.forEach(row => {
                        const cols = row.querySelectorAll('td');
                        let rowData = [];
                        // Ambil kolom 0 sampai 6 (abaikan kolom Aksi di index 7)
                        for (let i = 0; i < 7; i++) {
                            rowData.push('"' + cols[i].innerText.trim().replace(/"/g, '""') + '"');
                        }
                        csv.push(rowData.join(","));
                    });

                    const csvFile = new Blob(["\ufeff" + csv.join("\r\n")], {type: "text/csv;charset=utf-8"});
                    const downloadLink = document.createElement("a");
                    downloadLink.download = "antrian-permohonan.csv";
                    downloadLink.href = window.URL.createObjectURL(csvFile);
                    downloadLink.style.display = "none";
                    document.body.appendChild(downloadLink);
                    downloadLink.click();
                    document.body.removeChild(downloadLink);
                });
            }

            // Event Listener untuk Tombol Kirim (WhatsApp)
            if (btnKirim) {
                btnKirim.addEventListener('click', function() {
                    const rows = tableBody.querySelectorAll('tr.data-row');
                    
                    if (rows.length === 0) {
                        alert('Tabel antrian masih kosong. Silakan tambahkan data terlebih dahulu.');
                        return;
                    }

                    let message = "Halo Admin Pelayanan Kec. Plemahan, saya ingin mengajukan permohonan layanan sebagai berikut:%0A%0A";
                    
                    rows.forEach((row, index) => {
                        const cells = row.querySelectorAll('td');
                        // Mapping Index:
                        // 0: No, 1: Layanan, 2: Nama, 3: Desa, 4: Umur, 5: JK, 6: Telepon
                        
                        message += `*${index + 1}. ${cells[1].innerText}*%0A`;
                        message += `   - Nama: ${cells[2].innerText}%0A`;
                        message += `   - Desa: ${cells[3].innerText}%0A`;
                        message += `   - Umur: ${cells[4].innerText} tahun%0A`;
                        message += `   - JK: ${cells[5].innerText}%0A`;
                        message += `   - No. HP: ${cells[6].innerText}%0A%0A`;
                    });

                    message += "Mohon segera diproses. Terima kasih.";

                    // Buka WhatsApp (Ganti nomor sesuai kebutuhan)
                    window.open(`https://wa.me/6281234567890?text=${message}`, '_blank');
                });
            }

            // Load data saat halaman pertama kali dibuka
            loadDataFromLocal();
            loadDataFromCloud();
            updateFormHeight();
        });
    </script>
</body>
</html>